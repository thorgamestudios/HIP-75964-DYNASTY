<!doctype html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <title>HIP 76954 DYNASTY</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
      }
      header {
        background-color: #333;
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
      }
      .layout {
        display: flex;
        min-height: calc(100vh - 72px); /* subtract header height approx */
      }
      aside {
        width: 440px;
        background-color: #f4f4f4;
        padding: 1rem;
      }
      main {
        flex-grow: 1;
        padding: 1rem;
      }
      .nav-button {
        width: 100%;
        padding: 0.5rem;
        border: none;
        background-color: #ddd;
        cursor: pointer;
      }

      /* Overview list */
      .system-list {
        display: grid;
        grid-template-columns: repeat(3, 390px);
        gap: 1rem;
        justify-content: center;
      }
      .system-button {
        display: flex;
        align-items: center;
        width: 390px;
        padding: 1rem;
        border: 2px solid #ccc;
        border-radius: 8px;
        background-color: #f9f9f9;
        font-size: 1.1rem;
        gap: 0.5rem;
      }
      .add-btn {
        width: 24px;
        height: 24px;
        background-color: #2ecc71;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      .system-name {
        flex-grow: 1;
        cursor: pointer;
      }
      .inf-circle {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: bold;
      }
      .inf-circle.low {
        background-color: #e74c3c;
      }
      .inf-circle.medium {
        background-color: #f1c40f;
      }
      .inf-circle.high {
        background-color: #2ecc71;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>HIP 76954 DYNASTY</h1>
      <select id="sortSelect">
        <option value="population">Populace</option>
        <option value="percentage">Procenta</option>
        <option value="influence">Vliv</option>
      </select>
    </header>
    <div class="layout">
      <aside>
        <button id="homeBtn" class="nav-button">Hlavní strana</button>
        <button id="overviewBtn" class="nav-button">Přehled</button>
      </aside>
      <main id="content"></main>
    </div>
    <script>
      const overviewBtn = document.getElementById("overviewBtn");
      const homeBtn = document.getElementById("homeBtn");
      const sortSelect = document.getElementById("sortSelect");
      const content = document.getElementById("content");

      let factionPresence = [];
      let homeSystems = [];

      function addSystemToHome(p) {
        if (!homeSystems.find((s) => s.system_name === p.system_name)) {
          homeSystems.push(p);
        }
      }

      function renderSystems() {
        const sortBy = sortSelect.value;
        const sorted = [...factionPresence];
        if (sortBy === "population") {
          sorted.sort(
            (a, b) => (b.system_population || b.population || 0) - (a.system_population || a.population || 0),
          );
        } else if (sortBy === "percentage" || sortBy === "influence") {
          sorted.sort((a, b) => (b.influence || 0) - (a.influence || 0));
        }

        const list = document.createElement("div");
        list.className = "system-list";

        sorted.forEach((p) => {
          const row = document.createElement("div");
          row.className = "system-button";

          const addBtn = document.createElement("button");
          addBtn.className = "add-btn";
          addBtn.textContent = "+";
          addBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            addSystemToHome(p);
          });

          const nameSpan = document.createElement("span");
          nameSpan.className = "system-name";
          nameSpan.textContent = p.system_name;
          nameSpan.addEventListener("click", () => {
            window.open(
              `index.html?system=${encodeURIComponent(p.system_name)}`,
              "_blank",
            );
          });

          const inf = Math.round((p.influence || 0) * 100);
          const circle = document.createElement("span");
          circle.className = "inf-circle";
          circle.textContent = `${inf}%`;
          if (inf <= 30) circle.classList.add("low");
          else if (inf <= 50) circle.classList.add("medium");
          else circle.classList.add("high");

          row.appendChild(addBtn);
          row.appendChild(nameSpan);
          row.appendChild(circle);
          list.appendChild(row);
        });

        content.innerHTML = "";
        content.appendChild(list);
      }

      async function loadOverview() {
        content.innerHTML = "<p>Načítání...</p>";
        try {
          const res = await fetch(
            "https://elitebgs.app/api/ebgs/v5/factions?name=HIP%2076954%20DYNASTY",
          );
          if (!res.ok) throw new Error("Chyba API");
          const data = await res.json();
          const faction = data.docs && data.docs[0];
          if (!faction || !Array.isArray(faction.faction_presence)) {
            content.textContent = "Neočekávaný formát odpovědi API.";
            return;
          }

          factionPresence = faction.faction_presence;
          renderSystems();
        } catch (err) {
          console.error(err);
          content.textContent = "Nepodařilo se načíst data.";
        }
      }

      function loadHome() {
        const wrapper = document.createElement("div");
        const intro = document.createElement("p");
        intro.textContent = "Vítejte na hlavní stránce.";
        wrapper.appendChild(intro);

        if (homeSystems.length) {
          const list = document.createElement("div");
          list.className = "system-list";

          homeSystems.forEach((p) => {
            const row = document.createElement("div");
            row.className = "system-button";

            const nameSpan = document.createElement("span");
            nameSpan.className = "system-name";
            nameSpan.textContent = p.system_name;
            nameSpan.addEventListener("click", () => {
              window.open(
                `index.html?system=${encodeURIComponent(p.system_name)}`,
                "_blank",
              );
            });

            const inf = Math.round((p.influence || 0) * 100);
            const circle = document.createElement("span");
            circle.className = "inf-circle";
            circle.textContent = `${inf}%`;
            if (inf <= 30) circle.classList.add("low");
            else if (inf <= 50) circle.classList.add("medium");
            else circle.classList.add("high");

            row.appendChild(nameSpan);
            row.appendChild(circle);
            list.appendChild(row);
          });

          wrapper.appendChild(list);
        } else {
          const none = document.createElement("p");
          none.textContent = "Zatím nejsou vybrány žádné systémy.";
          wrapper.appendChild(none);
        }

        content.innerHTML = "";
        content.appendChild(wrapper);
      }

      async function loadSystemDetail(name) {
        content.innerHTML = "<p>Načítání...</p>";
        try {
          const res = await fetch(
            `https://elitebgs.app/api/ebgs/v5/systems?name=${encodeURIComponent(
              name,
            )}`,
          );
          if (!res.ok) throw new Error("Chyba API");
          const data = await res.json();
          const system = data.docs && data.docs[0];
          if (!system) {
            content.textContent = "Systém nenalezen.";
            return;
          }
          const pre = document.createElement("pre");
          pre.textContent = JSON.stringify(system, null, 2);
          content.innerHTML = "";
          content.appendChild(pre);
        } catch (err) {
          console.error(err);
          content.textContent = "Nepodařilo se načíst data systému.";
        }
      }

      homeBtn.addEventListener("click", loadHome);
      overviewBtn.addEventListener("click", loadOverview);
      sortSelect.addEventListener("change", () => {
        if (factionPresence.length) renderSystems();
      });

      const params = new URLSearchParams(window.location.search);
      const systemParam = params.get("system");
      if (systemParam) {
        loadSystemDetail(systemParam);
      } else {
        loadHome();
      }
    </script>
    </body>
</html>
