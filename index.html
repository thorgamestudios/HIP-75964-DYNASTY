<!doctype html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <title>Impérium HIP 76954 DYNASTY</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #000;
        color: #fff;
      }
      header {
        background-color: #000;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
      }
      .layout {
        display: flex;
        min-height: calc(100vh - 72px); /* subtract header height approx */
      }
      aside {
        width: 352px; /* reduced by 20% */
        background-color: #2b0030;
        padding: 1rem;
        color: #fff;
      }
      main {
        flex-grow: 1;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }
      .nav-button {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border: 2px solid transparent;
        border-radius: 8px;
        background-color: #000;
        color: #fff;
        cursor: pointer;
        transition:
          transform 0.1s,
          box-shadow 0.1s,
          border-color 0.1s;
      }
      .nav-button:hover {
        border-color: #ff00ff;
        box-shadow: 0 0 4px #ff00ff;
      }
      .nav-button.clicked {
        transform: scale(0.95);
      }

      /* Overview table */
      .system-table {
        border: 2px solid #ff00ff;
        border-collapse: collapse;
        margin: 1rem 0;
        background-color: #000;
        align-self: flex-start;
      }
      .system-table th,
      .system-table td {
        padding: 0.5rem;
        border: 1px solid #ffff00;
        text-align: left;
      }
      .system-table th {
        background-color: #000;
      }
      .system-table td:first-child {
        background-color: #000;
      }
      .overview-tables {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .faction-table-wrapper {
        border: 2px solid #00bfff;
        padding: 0.5rem;
      }
      .faction-table-wrapper .system-table {
        border-color: #00bfff;
      }
      .faction-input {
        margin-bottom: 0.5rem;
      }
      #sortSelect {
        color: #000;
      }
      .system-list {
        display: grid;
        grid-template-columns: repeat(3, 390px);
        gap: 1rem;
        justify-content: center;
        margin: 0 auto;
      }
      .system-button {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 1rem;
        border: 2px solid #ccc;
        border-radius: 8px;
        background-color: #f9f9f9;
        font-size: 1.1rem;
        gap: 0.5rem;
        color: #000;
      }
      tr.at-war {
        outline: 2px solid #ff0000;
        box-shadow: 0 0 8px #ff0000;
      }
      .home-table {
        width: 100%;
        border: 2px solid #ff00ff;
        border-collapse: collapse;
        margin: 1rem 0;
        background-color: #000;
        align-self: stretch;
      }
      .home-table th,
      .home-table td {
        border: 1px solid #ffff00;
        padding: 0.5rem;
        text-align: center;
      }
      .home-table th {
        background-color: #000;
      }
      .home-table th:nth-child(3),
      .home-table td:nth-child(3),
      .home-table th:nth-child(6),
      .home-table td:nth-child(6) {
        width: 150px;
      }
      .priority-star {
        color: #ffff00;
        font-size: 1.5rem;
      }
      .progress-container {
        width: 100%;
        background-color: #333;
        border-radius: 4px;
      }
      .progress-bar {
        height: 1rem;
        background-color: #2ecc71;
        border-radius: 4px;
      }
      .action-icons span {
        margin: 0 0.25rem;
        font-size: 1.2rem;
      }
      .add-btn {
        width: 24px;
        height: 24px;
        background-color: #2ecc71;
        color: #fff;
        border: 2px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition:
          transform 0.1s,
          box-shadow 0.1s,
          border-color 0.1s;
      }
      .add-btn:hover {
        border-color: #ff00ff;
        box-shadow: 0 0 4px #ff00ff;
      }
      .add-btn.clicked {
        transform: scale(0.95);
      }
      .remove-btn {
        width: 24px;
        height: 24px;
        background-color: #e74c3c;
        color: #fff;
        border: 2px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition:
          transform 0.1s,
          box-shadow 0.1s,
          border-color 0.1s;
      }
      .remove-btn:hover {
        border-color: #ff00ff;
        box-shadow: 0 0 4px #ff00ff;
      }
      .remove-btn.clicked {
        transform: scale(0.95);
      }
      .system-name {
        flex-grow: 1;
        cursor: pointer;
      }
      .inf-circle {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: bold;
      }
      .inf-circle.low {
        background-color: #e74c3c;
      }
      .inf-circle.medium {
        background-color: #f1c40f;
      }
      .inf-circle.high {
        background-color: #2ecc71;
      }

      #stats {
        background-color: #233;
        color: #fff;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        max-width: 600px;
      }
      #stats table {
        width: 100%;
        border-collapse: collapse;
      }
      #stats th,
      #stats td {
        padding: 0.25rem 0.5rem;
        text-align: left;
      }
      #stats canvas {
        width: 100%;
        height: 180px;
        margin-bottom: 0.5rem;
      }
      .detail-table {
        width: 100%;
        border-collapse: collapse;
      }
      .detail-table th,
      .detail-table td {
        padding: 0.25rem 0.5rem;
        text-align: left;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header>
      <h1>Impérium HIP 76954 DYNASTY</h1>
    </header>
    <div class="layout">
      <aside>
        <button id="homeBtn" class="nav-button">Hlavní strana</button>
        <button id="overviewBtn" class="nav-button">Přehled</button>
      </aside>
      <main id="content"></main>
    </div>
    <script>
      const overviewBtn = document.getElementById("overviewBtn");
      const homeBtn = document.getElementById("homeBtn");
      const content = document.getElementById("content");
      let sortSelect;

      let factionPresence = [];
      let homeSystems = [];
      let lastSortBy = "name";
      let sortAscending = true;
      let currentView = "home";
      let overviewTableContainer;

      function addAnimatedClick(el, handler) {
        el.addEventListener("click", (e) => {
          e.preventDefault();
          el.classList.add("clicked");
          setTimeout(() => {
            el.classList.remove("clicked");
            handler(e);
          }, 150);
        });
      }

      function addSystemToHome(p) {
        if (!homeSystems.find((s) => s.system_name === p.system_name)) {
          homeSystems.push(p);
          if (currentView === "home") loadHome();
        }
      }

      function removeSystemFromHome(name) {
        homeSystems = homeSystems.filter((s) => s.system_name !== name);
        if (currentView === "home") loadHome();
      }

      function stripEnumPrefix(value) {
        if (typeof value !== "string") return value;
        return value
          .replace(/^\$/, "")
          .replace(/;$/, "")
          .replace(/^system_security_/, "")
          .replace(/^government_/, "")
          .replace(/^economy_/, "");
      }

      function isAtWar(p) {
        const states = [];
        if (p.state) states.push(p.state);
        if (Array.isArray(p.active_states))
          states.push(...p.active_states.map((s) => s.state));
        if (Array.isArray(p.pending_states))
          states.push(...p.pending_states.map((s) => s.state));
        if (Array.isArray(p.recovering_states))
          states.push(...p.recovering_states.map((s) => s.state));
        return states.some((s) => /war/i.test(s));
      }

      function renderSystems() {
        const sortBy = lastSortBy;
        const sorted = [...factionPresence];
        sorted.sort((a, b) => {
          let val = 0;
          if (sortBy === "population") {
            val =
              (a.system_population || a.population || 0) -
              (b.system_population || b.population || 0);
          } else if (sortBy === "influence") {
            val = (a.influence || 0) - (b.influence || 0);
          } else {
            val = (a.system_name || "").localeCompare(b.system_name || "");
          }
          return sortAscending ? val : -val;
        });

        const tbl = document.createElement("table");
        tbl.className = "system-table";

        const headerRow = document.createElement("tr");
        const headerCell = document.createElement("th");
        headerCell.colSpan = 3;
        sortSelect = document.createElement("select");
        sortSelect.id = "sortSelect";
        sortSelect.innerHTML = `
          <option value="name">Název</option>
          <option value="influence">Vliv</option>
          <option value="population">Populace</option>
        `;
        sortSelect.value = sortBy;
        sortSelect.addEventListener("change", () => {
          lastSortBy = sortSelect.value;
          sortAscending = true;
          renderSystems();
        });
        sortSelect.addEventListener("click", () => {
          if (sortSelect.value === lastSortBy) {
            sortAscending = !sortAscending;
            renderSystems();
          }
        });
        headerCell.appendChild(sortSelect);
        headerRow.appendChild(headerCell);
        tbl.appendChild(headerRow);

        sorted.forEach((p) => {
          const row = document.createElement("tr");
          if (isAtWar(p)) row.classList.add("at-war");

          const addCell = document.createElement("td");
          const isHome = homeSystems.some((s) => s.system_name === p.system_name);
          const btn = document.createElement("button");
          btn.className = isHome ? "remove-btn" : "add-btn";
          btn.textContent = isHome ? "-" : "+";
          addAnimatedClick(btn, (e) => {
            e.stopPropagation();
            if (isHome) {
              removeSystemFromHome(p.system_name);
            } else {
              addSystemToHome(p);
            }
            renderSystems();
          });
          addCell.appendChild(btn);

          const nameCell = document.createElement("td");
          const nameSpan = document.createElement("span");
          nameSpan.className = "system-name";
          nameSpan.textContent = p.system_name;
          nameSpan.addEventListener("click", () => {
            window.location.href = `index.html?system=${encodeURIComponent(p.system_name)}`;
          });
          nameCell.appendChild(nameSpan);

          const infCell = document.createElement("td");
          const inf = Math.round((p.influence || 0) * 100);
          const circle = document.createElement("span");
          circle.className = "inf-circle";
          circle.textContent = `${inf}%`;
          if (inf <= 30) circle.classList.add("low");
          else if (inf <= 50) circle.classList.add("medium");
          else circle.classList.add("high");
          infCell.appendChild(circle);

          row.appendChild(addCell);
          row.appendChild(nameCell);
          row.appendChild(infCell);
          tbl.appendChild(row);
        });

        overviewTableContainer.innerHTML = "";
        overviewTableContainer.appendChild(tbl);
      }

      function renderFactionPresence(container, presence) {
        const sorted = [...presence].sort((a, b) => (a.system_name || "").localeCompare(b.system_name || ""));
        const tbl = document.createElement("table");
        tbl.className = "system-table";
        sorted.forEach((p) => {
          const row = document.createElement("tr");

          const nameCell = document.createElement("td");
          const nameSpan = document.createElement("span");
          nameSpan.className = "system-name";
          nameSpan.textContent = p.system_name;
          nameSpan.addEventListener("click", () => {
            window.location.href = `index.html?system=${encodeURIComponent(p.system_name)}`;
          });
          nameCell.appendChild(nameSpan);

          const infCell = document.createElement("td");
          const inf = Math.round((p.influence || 0) * 100);
          const circle = document.createElement("span");
          circle.className = "inf-circle";
          circle.textContent = `${inf}%`;
          if (inf <= 30) circle.classList.add("low");
          else if (inf <= 50) circle.classList.add("medium");
          else circle.classList.add("high");
          infCell.appendChild(circle);

          row.appendChild(nameCell);
          row.appendChild(infCell);
          tbl.appendChild(row);
        });
        container.innerHTML = "";
        container.appendChild(tbl);
      }

      function createFactionTable() {
        const wrap = document.createElement("div");
        wrap.className = "faction-table-wrapper";

        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "Frakce";
        input.className = "faction-input";

        const btn = document.createElement("button");
        btn.textContent = "Aktualizovat";

        const result = document.createElement("div");

        async function update() {
          const name = input.value.trim();
          if (!name) {
            result.innerHTML = "";
            return;
          }
          result.innerHTML = "<p>Načítání...</p>";
          try {
            const res = await fetch(`https://elitebgs.app/api/ebgs/v5/factions?name=${encodeURIComponent(name)}`);
            if (!res.ok) throw new Error("Chyba API");
            const data = await res.json();
            const faction = data.docs && data.docs[0];
            if (!faction || !Array.isArray(faction.faction_presence)) {
              result.textContent = "Frakce nenalezena.";
              return;
            }
            renderFactionPresence(result, faction.faction_presence);
          } catch (err) {
            console.error(err);
            result.textContent = "Nepodařilo se načíst data.";
          }
        }

        btn.addEventListener("click", update);

        wrap.appendChild(input);
        wrap.appendChild(btn);
        wrap.appendChild(result);
        return wrap;
      }

      async function loadOverview() {
        currentView = "overview";
        content.innerHTML = "<p>Načítání...</p>";
        try {
          const res = await fetch(
            "https://elitebgs.app/api/ebgs/v5/factions?name=HIP%2076954%20DYNASTY",
          );
          if (!res.ok) throw new Error("Chyba API");
          const data = await res.json();
          const faction = data.docs && data.docs[0];
          if (!faction || !Array.isArray(faction.faction_presence)) {
            content.textContent = "Neočekávaný formát odpovědi API.";
            return;
          }

          factionPresence = faction.faction_presence;
          const wrapper = document.createElement("div");
          wrapper.className = "overview-tables";
          overviewTableContainer = document.createElement("div");
          wrapper.appendChild(overviewTableContainer);
          renderSystems();
          for (let i = 0; i < 3; i++) {
            wrapper.appendChild(createFactionTable());
          }
          content.innerHTML = "";
          content.appendChild(wrapper);
        } catch (err) {
          console.error(err);
          content.textContent = "Nepodařilo se načíst data.";
        }
      }

      async function loadFactionStats(container) {
        container.innerHTML = "<p>Načítání statistik...</p>";
        try {
          const res = await fetch(
            "https://elitebgs.app/api/ebgs/v5/factions?name=HIP%2076954%20DYNASTY",
          );
          if (!res.ok) throw new Error("Chyba API");
          const data = await res.json();
          const faction = data.docs && data.docs[0];
          if (!faction || !Array.isArray(faction.faction_presence)) {
            container.textContent = "Statistiky nejsou k dispozici.";
            return;
          }
          const pres = faction.faction_presence;
          const totalPop = pres.reduce((s, p) => s + (p.population || 0), 0);
          const weightedPop = pres.reduce(
            (s, p) => s + (p.population || 0) * (p.influence || 0),
            0,
          );
          const avgInf = pres.length
            ? pres.reduce((s, p) => s + (p.influence || 0), 0) / pres.length
            : 0;

          container.innerHTML = "";
          const canvas = document.createElement("canvas");
          container.appendChild(canvas);

          new Chart(canvas.getContext("2d"), {
            type: "line",
            data: {
              labels: pres.map((p) => p.system_name),
              datasets: [
                {
                  label: "Populace",
                  data: pres.map((p) => p.population || 0),
                  borderColor: "#f1c40f",
                  backgroundColor: "rgba(241,196,15,0.2)",
                  tension: 0.3,
                },
              ],
            },
            options: {
              scales: { x: { display: false } },
              plugins: { legend: { display: false } },
            },
          });

          const tbl = document.createElement("table");
          tbl.innerHTML = `
            <tr><th>Populace</th><td>${totalPop.toLocaleString()}</td></tr>
            <tr><th>Populace podle vlivu</th><td>${Math.round(weightedPop).toLocaleString()}</td></tr>
            <tr><th>Systémy</th><td>${pres.length}</td></tr>
            <tr><th>Průměrný vliv</th><td>${(avgInf * 100).toFixed(2)}%</td></tr>
          `;
          container.appendChild(tbl);
        } catch (err) {
          console.error(err);
          container.textContent = "Nepodařilo se načíst statistiky.";
        }
      }

      function loadHome() {
        currentView = "home";
        const wrapper = document.createElement("div");
        wrapper.style.width = "100%";
        const intro = document.createElement("p");
        intro.textContent = "Vítejte na hlavní stránce.";
        wrapper.appendChild(intro);

        if (homeSystems.length) {
          const tbl = document.createElement("table");
          tbl.className = "home-table";
          tbl.innerHTML = `
            <tr>
              <th>Systém</th>
              <th>Priorita</th>
              <th>Cíle</th>
              <th>Stav podpory</th>
              <th>Podpořili</th>
              <th>Co dělat</th>
            </tr>
          `;

          homeSystems.forEach((p) => {
            const row = document.createElement("tr");
            if (isAtWar(p)) row.classList.add("at-war");

            const nameTd = document.createElement("td");
            const nameSpan = document.createElement("span");
            nameSpan.className = "system-name";
            nameSpan.textContent = p.system_name;
            nameSpan.addEventListener("click", () => {
              window.location.href = `index.html?system=${encodeURIComponent(p.system_name)}`;
            });
            nameTd.appendChild(nameSpan);

            const priorityTd = document.createElement("td");
            priorityTd.innerHTML = '<span class="priority-star">★</span>';

            const goalsTd = document.createElement("td");

            const supportTd = document.createElement("td");
            const inf = Math.round((p.influence || 0) * 100);
            const progContainer = document.createElement("div");
            progContainer.className = "progress-container";
            const progBar = document.createElement("div");
            progBar.className = "progress-bar";
            progBar.style.width = "0%";
            progContainer.appendChild(progBar);
            supportTd.appendChild(progContainer);

            const supportedTd = document.createElement("td");

            const actionsTd = document.createElement("td");
            actionsTd.className = "action-icons";
            actionsTd.innerHTML = "<span>💀</span><span>⚡</span><span>💰</span><span>⭐</span>";

            row.appendChild(nameTd);
            row.appendChild(priorityTd);
            row.appendChild(goalsTd);
            row.appendChild(supportTd);
            row.appendChild(supportedTd);
            row.appendChild(actionsTd);
            tbl.appendChild(row);
          });

          wrapper.appendChild(tbl);
        } else {
          const none = document.createElement("p");
          none.textContent = "Zatím nejsou vybrány žádné systémy.";
          wrapper.appendChild(none);
        }

        const statsDiv = document.createElement("div");
        statsDiv.id = "stats";
        wrapper.appendChild(statsDiv);
        loadFactionStats(statsDiv);

        content.innerHTML = "";
        content.appendChild(wrapper);
      }

      async function loadSystemDetail(name) {
        content.innerHTML = "<p>Načítání...</p>";
        try {
          const res = await fetch(
            `https://elitebgs.app/api/ebgs/v5/systems?name=${encodeURIComponent(
              name,
            )}`,
          );
          if (!res.ok) throw new Error("Chyba API");
          const data = await res.json();
          const system = data.docs && data.docs[0];
          if (!system) {
            content.textContent = "Systém nenalezen.";
            return;
          }
          const wrapper = document.createElement("div");
          const tbl = document.createElement("table");
          tbl.className = "detail-table";
          const security = stripEnumPrefix(system.security);
          const government = stripEnumPrefix(system.government);
          const primaryEconomy = stripEnumPrefix(system.primary_economy);
          const secondaryEconomy = stripEnumPrefix(system.secondary_economy);
          tbl.innerHTML = `
            <tr><th>Název systému</th><td>${system.name}</td></tr>
            <tr><th>Allegiance</th><td>${system.allegiance || "—"}</td></tr>
            <tr><th>Řídící frakce</th><td>${system.controlling_minor_faction || "—"}</td></tr>
            <tr><th>Stav systému</th><td>${system.state || "—"}</td></tr>
            <tr><th>Bezpečnost</th><td>${security || "—"}</td></tr>
            <tr><th>Vláda</th><td>${government || "—"}</td></tr>
            <tr><th>Primární ekonomika</th><td>${primaryEconomy || "—"}</td></tr>
            <tr><th>Sekundární ekonomika</th><td>${secondaryEconomy || "—"}</td></tr>
            <tr><th>Populace</th><td>${(system.population || 0).toLocaleString()}</td></tr>
            <tr><th>Poslední aktualizace dat</th><td>${system.updated_at ? new Date(system.updated_at).toLocaleString() : "—"}</td></tr>
          `;
          wrapper.appendChild(tbl);

          let stations = [];
          try {
            const stationsRes = await fetch(
              `https://elitebgs.app/api/ebgs/v5/stations?systemName=${encodeURIComponent(
                name,
              )}`,
            );
            if (stationsRes.ok) {
              const stationsData = await stationsRes.json();
              stations = stationsData.docs || [];
            }
          } catch (e) {
            console.error(e);
          }
          if (stations.length) {
            const stTitle = document.createElement("h3");
            stTitle.textContent = "Stanice";
            wrapper.appendChild(stTitle);
            const stList = document.createElement("ul");
            stations.forEach((s) => {
              const li = document.createElement("li");
              const gov = stripEnumPrefix(s.government);
              const econ = stripEnumPrefix(s.primary_economy || s.economy);
              li.textContent = `${s.name} (${gov || "—"}, ${econ || "—"})`;
              stList.appendChild(li);
            });
            wrapper.appendChild(stList);
          }

          if (system.conflicts && system.conflicts.length) {
            const confTitle = document.createElement("h3");
            confTitle.textContent = "Konflikty";
            wrapper.appendChild(confTitle);
            const confList = document.createElement("ul");
            system.conflicts.forEach((c) => {
              const li = document.createElement("li");
              const f1 = c.faction1 && c.faction1.name ? c.faction1.name : "";
              const f2 = c.faction2 && c.faction2.name ? c.faction2.name : "";
              const status = c.status || c.type || "";
              li.textContent = `${f1} vs ${f2} (${status})`;
              confList.appendChild(li);
            });
            wrapper.appendChild(confList);
          }

          if (system.factions && system.factions.length) {
            const facTitle = document.createElement("h3");
            facTitle.textContent = "Frakce v systému";
            wrapper.appendChild(facTitle);
            const facList = document.createElement("ul");
            system.factions.forEach((f) => {
              const li = document.createElement("li");
              const inf = Math.round((f.influence || 0) * 100);
              li.textContent = `${f.name} (${inf}%)`;
              facList.appendChild(li);
            });
            wrapper.appendChild(facList);
          }

          content.innerHTML = "";
          content.appendChild(wrapper);
        } catch (err) {
          console.error(err);
          content.textContent = "Nepodařilo se načíst data systému.";
        }
      }

      addAnimatedClick(homeBtn, loadHome);
      addAnimatedClick(overviewBtn, loadOverview);

      const params = new URLSearchParams(window.location.search);
      const systemParam = params.get("system");
      if (systemParam) {
        loadSystemDetail(systemParam);
      } else {
        loadHome();
      }
    </script>
  </body>
</html>
