<!doctype html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <title>HIP 75964 DYNASTY</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
      }
      header {
        background-color: #333;
        color: #fff;
        text-align: center;
        padding: 1rem;
      }
      .layout {
        display: flex;
        min-height: calc(100vh - 72px); /* subtract header height approx */
      }
      aside {
        width: 200px;
        background-color: #f4f4f4;
        padding: 1rem;
      }
      main {
        flex-grow: 1;
        padding: 1rem;
      }
      .nav-button {
        width: 100%;
        padding: 0.5rem;
        border: none;
        background-color: #ddd;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>HIP 75964 DYNASTY</h1>
    </header>
    <div class="layout">
      <aside>
        <button id="overviewBtn" class="nav-button">Přehled</button>
      </aside>
      <main id="content"></main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const overviewBtn = document.getElementById("overviewBtn");
      const content = document.getElementById("content");

      async function loadOverview() {
        content.innerHTML = "<p>Načítání...</p>";
        try {
          const factionName = "HIP 75964 DYNASTY";
          const factionRes = await fetch(
            `https://elitebgs.app/api/ebgs/v5/factions?factionName=${encodeURIComponent(factionName)}`,
          );
          if (!factionRes.ok) throw new Error("Chyba API");
          const factionData = await factionRes.json();
          console.log("Faction response", factionData);
          let presence = [];
          if (factionData.docs && factionData.docs[0]) {
            presence =
              factionData.docs[0].faction_presence ||
              factionData.docs[0].presence ||
              [];
            if (!Array.isArray(presence)) {
              alert("Neočekávaný formát odpovědi API.");
              console.error("Unexpected API response", factionData);
              presence = [];
            }
          } else {
            alert("Neočekávaný formát odpovědi API.");
            console.error("Unexpected API response", factionData);
          }

          if (presence.length === 0) {
            content.textContent = "Frakce není přítomna v žádném systému.";
            return;
          }

          const settled = await Promise.allSettled(
            presence.map(async (p) => {
              const sysRes = await fetch(
                `https://elitebgs.app/api/ebgs/v5/systems?name=${encodeURIComponent(p.system_name)}`,
              );
              if (!sysRes.ok) throw new Error("Chyba API");
              const sysData = await sysRes.json();
              return sysData.docs[0];
            }),
          );

          const systems = settled
            .filter((r) => r.status === "fulfilled" && r.value)
            .map((r) => r.value);

          content.innerHTML = "";
          systems.forEach((sys) => {
            const section = document.createElement("section");
            const title = document.createElement("h2");
            title.textContent = sys.name;
            section.appendChild(title);

            const canvas = document.createElement("canvas");
            section.appendChild(canvas);

            content.appendChild(section);

            const labels = sys.factions.map(
              (f) => `${f.name} ${(f.influence * 100).toFixed(1)}%`,
            );
            const dataValues = sys.factions.map((f) =>
              (f.influence * 100).toFixed(1),
            );
            const colors = labels.map(
              () =>
                "#" +
                Math.floor(Math.random() * 16777215)
                  .toString(16)
                  .padStart(6, "0"),
            );

            new Chart(canvas, {
              type: "pie",
              data: {
                labels: labels,
                datasets: [
                  {
                    data: dataValues,
                    backgroundColor: colors,
                  },
                ],
              },
              options: {
                plugins: {
                  legend: {
                    position: "bottom",
                  },
                },
              },
            });
          });
        } catch (err) {
          console.error(err);
          content.textContent = "Nepodařilo se načíst data.";
        }
      }

      overviewBtn.addEventListener("click", loadOverview);
    </script>
  </body>
</html>
